<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYPO3 Upgrade Analysis - Detailed Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #ff8700;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff8700;
        }
        .risk-critical { border-left-color: #dc3545; }
        .risk-high { border-left-color: #fd7e14; }
        .risk-medium { border-left-color: #ffc107; }
        .risk-low { border-left-color: #28a745; }
        .extension {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .extension-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .extension-body {
            padding: 20px;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-critical { background: #dc3545; color: white; }
        .badge-high { background: #fd7e14; color: white; }
        .badge-medium { background: #ffc107; color: black; }
        .badge-low { background: #28a745; color: white; }
        .availability {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .availability-item {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .available { background: #d4edda; color: #155724; }
        .unavailable { background: #f8d7da; color: #721c24; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        .table-status {
            font-size: 16px;
            font-weight: bold;
        }
        .status-available {
            color: #28a745;
        }
        .status-unavailable {
            color: #dc3545;
        }
        .footer {
            margin-top: 50px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TYPO3 Upgrade Analysis - Detailed Report</h1>
        <p><strong>Generated:</strong> {{ generated_at.format('Y-m-d H:i:s') }}</p>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <h3>Installation</h3>
            <p><strong>Path:</strong> {{ installation.path }}</p>
            <p><strong>Current Version:</strong> {{ installation.version.toString() }}</p>
            <p><strong>Target Version:</strong> {{ target_version }}</p>
            <p><strong>Type:</strong> {{ installation.type }}</p>
        </div>
        
        <div class="summary-card">
            <h3>Extensions</h3>
            <p><strong>Total:</strong> {{ statistics.total_extensions }}</p>
            <p><strong>Critical Risk:</strong> {{ statistics.critical_extensions }}</p>
            <p><strong>No Availability:</strong> {{ statistics.availability_stats.no_availability }}</p>
        </div>
        
        <div class="summary-card">
            <h3>Risk Distribution</h3>
            {% for level, count in statistics.risk_distribution %}
            <p><span class="badge badge-{{ level }}">{{ level }}</span> {{ count }}</p>
            {% endfor %}
        </div>
        
        <div class="summary-card">
            <h3>Availability</h3>
            <p><strong>TER:</strong> {{ statistics.availability_stats.ter_available }}</p>
            <p><strong>Packagist:</strong> {{ statistics.availability_stats.packagist_available }}</p>
            <p><strong>Git:</strong> {{ statistics.availability_stats.git_available }}</p>
        </div>
    </div>

    <h2>Extensions Overview</h2>
    <table>
        <thead>
            <tr>
                <th>Extension</th>
                <th>Version</th>
                <th>Risk Level</th>
                <th>Available</th>
                <th>Latest Version</th>
            </tr>
        </thead>
        <tbody>
            {% for data in extension_data %}
            <tr>
                <td><strong>{{ data.extension.key }}</strong></td>
                <td>{{ data.extension.version ? data.extension.version.toString() : 'N/A' }}</td>
                <td><span class="badge badge-{{ data.risk_summary.risk_level }}">{{ data.risk_summary.risk_level|upper }}</span></td>
                <td>{% if data.version_analysis %}{% if data.version_analysis.ter_available or data.version_analysis.packagist_available or data.version_analysis.git_available %}✅{% else %}❌{% endif %}{% else %}❓{% endif %}</td>
                <td>{{ data.version_analysis and data.version_analysis.git_latest_version ? data.version_analysis.git_latest_version : 'N/A' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Detailed Extension Analysis</h2>
    
    {% for data in extension_data %}
    <div class="extension">
        <div class="extension-header">
            <h3>{{ data.extension.key }}</h3>
            <span class="badge badge-{{ data.risk_summary.risk_level }}">
                {{ data.risk_summary.risk_level }} Risk ({{ "%.1f"|format(data.risk_summary.overall_risk) }})
            </span>
        </div>
        
        <div class="extension-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>Extension Information</h4>
                    <p><strong>Type:</strong> {{ data.extension.isSystemExtension ? 'System' : (data.extension.isLocalExtension ? 'Local' : 'Third-party') }}</p>
                    <p><strong>Active:</strong> {{ data.extension.isActive ? 'Yes' : 'No' }}</p>
                    {% if data.extension.hasComposerName %}
                    <p><strong>Composer:</strong> <code>{{ data.extension.composerName }}</code></p>
                    {% endif %}
                    {% if data.extension.version %}
                    <p><strong>Version:</strong> {{ data.extension.version.toString() }}</p>
                    {% endif %}
                    
                    {% if data.loc_analysis %}
                    <h4>Codebase Analysis</h4>
                    <p><strong>Total Lines:</strong> {{ data.loc_analysis.total_lines|number_format }}</p>
                    <p><strong>PHP Files:</strong> {{ data.loc_analysis.php_files }}</p>
                    <p><strong>Code Lines:</strong> {{ data.loc_analysis.code_lines|number_format }}</p>
                    <p><strong>Comment Lines:</strong> {{ data.loc_analysis.comment_lines|number_format }}</p>
                    <p><strong>Average File Size:</strong> {{ data.loc_analysis.average_file_size }} lines</p>
                    <p><strong>Largest File:</strong> {{ data.loc_analysis.largest_file_lines }} lines<br>
                       <small>({{ data.loc_analysis.largest_file_path }})</small></p>
                    <p><strong>Classes:</strong> {{ data.loc_analysis.classes }} | 
                       <strong>Methods:</strong> {{ data.loc_analysis.methods }} | 
                       <strong>Functions:</strong> {{ data.loc_analysis.functions }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <h4>Version Availability</h4>
                    {% if data.version_analysis %}
                    <div class="availability">
                        <span class="availability-item {{ data.version_analysis.ter_available ? 'available' : 'unavailable' }}">
                            TER {{ data.version_analysis.ter_available ? '✓' : '✗' }}
                        </span>
                        <span class="availability-item {{ data.version_analysis.packagist_available ? 'available' : 'unavailable' }}">
                            Packagist {{ data.version_analysis.packagist_available ? '✓' : '✗' }}
                        </span>
                        <span class="availability-item {{ data.version_analysis.git_available ? 'available' : 'unavailable' }}">
                            Git {{ data.version_analysis.git_available ? '✓' : '✗' }}
                        </span>
                    </div>
                    
                    {% if data.version_analysis.git_repository_url %}
                    <p><strong>Git Repository:</strong> 
                        <a href="{{ data.version_analysis.git_repository_url }}" target="_blank">{{ data.version_analysis.git_repository_url }}</a>
                    </p>
                    {% if data.version_analysis.git_repository_health %}
                    <p><strong>Repository Health:</strong> {{ "%.0f"|format(data.version_analysis.git_repository_health * 100) }}%</p>
                    {% endif %}
                    {% if data.version_analysis.git_latest_version %}
                    <p><strong>Latest Compatible Version:</strong> {{ data.version_analysis.git_latest_version }}</p>
                    {% endif %}
                    {% endif %}
                    
                    {% if data.version_analysis.recommendations %}
                    <h4>Recommendations</h4>
                    <ul>
                        {% for recommendation in data.version_analysis.recommendations %}
                        <li>{{ recommendation }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% else %}
                    <p><em>No version analysis data available</em></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <div class="footer">
        <p>This report was generated by TYPO3 Upgrade Analyzer on {{ generated_at.format('Y-m-d H:i:s') }}</p>
    </div>
</body>
</html>